---
title: "CBM Spades Manual"
subtitle: "`r paste('v.', Sys.getenv('SpadesCBM_MAN_VERSION'))`"
author: "Céline Boisvenue"
date: "26 June 2024"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
```{r setup-CBM_core, include = FALSE}
```

# CBM_core

:::{.rmdimportant}
This documentation is work in progress. Potential discrepancies and omissions may exist for the time being. If you find any, please contact us [here]("https://github.com/PredictiveEcology/CBM_core/issues").
:::

## Overview

[CBM_core](https://github.com/PredictiveEcology/CBM_core.git) is the central module of [spadesCBM](https://github.com/PredictiveEcology/spadesCBM.git). This is where all the carbon transfers are calculated at every time step, where disturbances are applied, and stocks are tracked. It doesn't run on its own, it needs parameters from either [CBM_defaults](https://github.com/PredictiveEcology/CBM_defaults.git), [CBM_dataPrep_SK](https://github.com/PredictiveEcology/CBM_dataPrep_SK.git), and [CBM_vol2biomass](https://github.com/PredictiveEcology/CBM_vol2biomass.git) (as per the provided example for managed forests of Saskatchewan) or the equivalent information from the user. In *SpaDES-speak*, this module has five events (`Init`, `spinup`, `postspinup`, `annual`, `accumulateResults`). Only in two of these events do carbon transactions occur: `spinup` and `annual`. The other events are tools to enable these transactions. All events are scheduled only once except for the `annual` event, who schedules itself until the end of the simulation horizon. Only in this module are the Python functions from the [libcbm](https://github.com/cat-cfs/libcbm_py/tree/main) package called. The functions used in this module are the [libcbm cbm-exn](https://github.com/cat-cfs/libcbm_py/tree/main/libcbm/model/cbm_exn) exclusively, these were designed to accept external biomass increments. These are used in the `spinup` and in the `annual` events only.

## Background

In [CBM_core](https://github.com/PredictiveEcology/CBM_core.git), the approach described in our [Overview](link to the overview section) section applied. Parameters are easily accessible via normal R-functions, and the SpaDES toolkit enables a modular, repetable contiuous workflow. This brings the transparency and flexibility needed for scientist to modify, evaluate and test new inputs, new data, and new algorithms while permitting non-researcher users to use the system.


## Inputs

| Name              | Class      | Description                                                  | Source          |
|-----------------|-----------------|-----------------------|-----------------|
| growth_increments | Data table | growth increment matrix | CBM_vol2biomass |
| level3DT          | Data table | pixelGroup level table with all collapsed raster information | CBM_dataPrep_SK |
| spatialDT         | Data table | Pixel level table with all collapsed raster information      | CBM_dataPrep_SK |
| masterRaster      | SpatRaster | Raster of study area | User provided, for SK: [Google Drive](https://drive.google.com/file/d/1zUyFH8k6Ef4c_GiWMInKbwAl6m6gvLJW)                                                             |
| pooldef           | Character  | Vector of pools                                              | CBM_defaults    |
| spinupSQL         | Data table | Parameters for CBM_core spinup event                         | CBM_defaults    |
| speciesPixelGroup | Data table | Data table | Table connecting pixel groups to species IDs | CBM_dataPrep_SK |
| realAges | Numeric | Extracted ages for each pixel group | CBM_dataPrep_SK |
| mySpuDmids | Data table | Summary table of possible CBM-CFS3 disturbances within study area spatial units | CBM_dataPrep_SK |
| disturbanceRasters | Character | Disturbance rasters for the study area for the duration of simulation | User provided, for SK: [Google Drive](https://drive.google.com/file/d/12YnuQYytjcBej0_kdodLchPg7z9LygCt) |
| disturbanceMatrix | Data table | Default disturbance data                                     | CBM_defaults    |
| historicDMtype | Numeric | Historical disturbance type for each pixel group | CBM_dataPrep_SK |
| lastPassDMtype | Numeric | Last pass disturebance type for each pizel group | CBM_dataPrep_SK |

## Module functioning

### Events

**Camille: can you make this a paragraph?**
Describe events - what does init do: creates all the Python connection and environment (check with Susan she is working on it now).
The `spinup` is the landscape initialization event as described in [Overview](link to that section) section, where records are grown and burnt until a stabilization of the below ground carbon pools. The `cbmExnSpinup` function, int R folder of the [CBM_core]() module, set-ups the inputs and calls the Python function that defines the model structure ([cbm_exn_get_default_parameters](https://cat-cfs.github.io/libcbm_py/cbm_exn_custom_ops.html#Appendix-1:-CBM-EXN-Default-parameters) and runs the carbon transfers necessary for the grow-burn cycle ([cbm_exn_spinup](https://cat-cfs.github.io/libcbm_py/cbm_exn_custom_ops.html#Appendix-1:-CBM-EXN-Default-parameters)).

postspinup: not sure what happens here anymore - check with Susan.

The `annual` is where all the carbon transfers are applied. Disturbances are matches to the correct records, and the transfers listed in Table XX of the [Overview](link to overview correct section) are applied. Details of default transfer rates, which we use in our SK example used throughout this manual are in the following section.

`accumulateResults` is the event that saves the output as outline in the `globalSK.R`. In the case of our SK example, we output the `cbmPool` and the Net Primary Productivity estimate ([`NPP`](link to lexicon)) for each year simulated. These are in the project outputs folder ("~/GitHub/spadesCBM/outputs") .


### Carbon Transfers

There are 18 internal carbon pools in [spadesCBM](https://github.com/PredictiveEcology/spadesCBM.git) (see Table 1 in Overview), one for the atmosphere and one for harvested wood exiting the system. Disturbances are the first carbon transfer to be applied to each record. Half the annual increment is then added (transfer from the atmosphere to the three above ground biomass pools - `Merch`, `Foliage`, and `Other`). Disturbances inputs are processes externally to [CBM_core](https://github.com/PredictiveEcology/CBM_core.git), in our example the are processes in [CBM_dataPrep_SK](https://github.com/PredictiveEcology/CBM_dataPrep_SK.git), leaving [CBM_core](https://github.com/PredictiveEcology/CBM_core.git) free of spatial data manipulations. Disturbance matrices specify the proportion of carbon in each pool to be transferred to other pools or to be taken out of the system (via forest products (pool named `Products`) or back to the atmosphere). Figure XX gives an example of transfers during a fire in SK. 

**INSERT VINI'S DIST MATRIX TRANSFER FIGURE**. 

The amount of carbon transferred from the atmosphere to the above ground biomass pools is determined from the growth curves, which were translated from $m^3/ha$ to carbon increments in [CBM_vol2biomass](https://github.com/PredictiveEcology/CBM_vol2biomass.git) and provided to [CBM_core](https://github.com/PredictiveEcology/CBM_core.git) in carbon increments (in tonnes of carbon/ha). In our example the object `simMngedSK$growth_increments` has the increments used for simulation. Dead Organic Matter ([DOM](link to lexicon)) turnover happens next and transfers carbon from the pools representing snags (`StemSnags` and `BranchSnags`), to the `MediumSoil`, and `AboveGroundFastSoil` pools. Biomass turnover follows with transfers from the `Merch`, `Foliage`, `Other`, `FineRoots` and `CoarseRoots`, to the pools representing the snags (`StemSnags` and `BranchSnags`), `AboveGroundVeryFastSoil`,	`BelowGroundFastSoil`, `AboveGroundVeryFastSoil` and `BelowGroundVeryFastSoil pools`. Carbon is never lost in the system, but increments are at times negative.  To accommodate negative increment values, a carbon transfer labelled `overmature_decline`, moves carbon between the `Merch`, `Other`, `Foliage`, `CoarseRoots` and `FineRoots` to pools representing stem an branch snags, and the `AboveGroundFastSoil`, `AboveGroundVeryFastSoil`, `BelowGroundFastSoil`, and `BelowGroundVeryFastSoil` pools. The transfers are portioned in the same way as annual process turnover and the amount is equal to the loss of each individual biomass pool according to the negative increment. Following the `overmature_decline` transfers, the second half of the growth is added to the three above ground biomass pools - `Merch`, `Foliage`, and `Other`. 

Next, the transfers due to decay are performed. Applied decay rates ($a_k$) are calculated for each DOM pool($_k$) as per **Equation 1** (see @kurz2009). 

**Equation 1.** 
$a_k = D_k * TempMod * StandMod$

Where:

$D_k$ is the base decay rate (yr−1) at a reference mean annual temperature ($RefTemp$).

$TempMod$ is a temperature modifier, as per **Equation 2**,  and $StandMod$ is a stand modifier as per **Equation 3** (@kurz1999).

**Equation 2,**

*TempMod = *$e^{((MAT_i -RefTemp)} X ln(Q_{10}) X 0.1)$

Where:

$MAT_i$ is the mean annual temperature of each spatial analysis unit.

$RefTemp$ is the reference mean annual temperature. 

$Q_10$ is a temperature coefficient.


**Equation 3.**

$StandMod =  1+(max_r - 1) * e^{(-b * TotBio/MaxBio)}$

Where:

$max_r$ is the open canopy decay rate multiplier (default value of 1).

$TotBio$ is the total aboveground biomass, $MaxBio$ is the maximum aboveground biomass for the specified stand type, and 

$b$ is a reduction factor calculated such that at 10% of maximum biomass, decomposition rates are reduce by 50% (set at 6.93 see @kurz1999).

The default values for base decay rate ($D_k$), $RefTemp$, $Q_10$ and $max_r$ for [spadesCBM](https://github.com/PredictiveEcology/spadesCBM.git) simulations are found [here](libcbm/resources/cbm_exn/decay_parameters.csv). 

The final carbon transfers represents the physical transfer rate from the above- to belowground slow pool and is set at of 0.006 yr−1 ([`slowmixing`](libcbm/resources/cbm_exn/slow_mixing_rate.csv)) is based on the transfer rate for dissolved organic C reported in the literature for some Canadian forest soils @moore2003.

### Parameters

Default parameters for simulations are available mainly from [default `.csv` files](libcbm/resources/cbm_exn) with a few pieces of information such as `mean_annual_temperature` used in decay rates calculates, `return_interval`, `min_rotations` and `max_rotations` used in the `spinup` or initialization process available in an [SQLight database](https://github.com/cat-cfs/libcbm_py/tree/main/libcbm/resources/cbm_defaults_db). Decay parameter values are linked to in the above decay explanation and calculations. 

The amount of carbon in the `CoarseRoots` and `FineRoots` pools depends on the carbon in the three above ground pools that absorb carbon from the atmosphere, `Merch`, `Other`, and `Foliage`. The total root biomass is estimated using empirical equations, one set for hardwood  and one for softwood species (@kurz2009, @li2003).(**Equation 4.**)(**Equation 5.**)

**Equation 4.**

$T_{hw}$ *=* $hw_a$ *X* $((Merch_{hw} + Foliage_{hw} + Other_{hw})$* X *$2)^{hw_b}$

**Equation 5.**

$T_{sw}$ *=* $sw_a$ *X* $((Merch_{sw} + Foliage_{sw} + Other_{sw})$* X *$2)$

**Equation 6.**

$P_{fine}$ *=* $frp_a + frp_b$ *X* $e^{((-1/frp_c)X(T_{hw} + T_{sw}))}$

**Equation 7.**

$FineRoots_{hw}$ *=* $T_{hw}$ *X* $P_{fine}$ 

**Equation 8.**

$FineRoots_{sw}$ *=* $T_{sw}$ *X* $P_{fine}$ 

**Equation 9.**

$CoarseRoots_{hw}$ *=* $T_{hw}$ *X* $(1-P_{fine})$ 

**Equation 10.**

$CoarseRoots_{sw}$ *=* $T_{sw}$ *X* $(1-P_{fine})$



### Results

In our example, we specify in the `globalSK.R` script that we want NPP and cbmPools saved every year (lines 81-85 - **NOTE these line references will change when the Python environment stuff moved to the init of this module). A user could specify outputs for any pools (see Table 1 in [Overview](link to table in Overview)).

NPP is
calculated as the sum of net growth (i.e. growth that results
in positive increment) and growth that replaces material lost
to biomass turnover during the year. In young, actively growing
stands, a large proportion of NPP results in positive growth
increment while in older, mature stands, a larger proportion
of NPP is allocated to replacement of material lost to turnover.
NPP is calculated in this manner because the CBM-CFS3 does
not simulate photosynthesis and autotrophic respiration.

## Outputs

| Name              | Class      | Description                                                     |
|------------------|------------------|-------------------------------------|
| spinup_input      | List       | input parameters for the spinup functions                       |
| cbm_vars          | List       | List of 4 data tables: parameters, pools, flux, and state       |
| spinupResults     | Data frame | Pools post spinup in order of pixelGroup                        |
| pixelGroupC       | Data table | All vectors (pixelGroup columns) and pools for simulation year. |
| pixelKeep         | Data table | Tracking all pixels' pixel group through simulations            |
| cbmPools          | Data table | All pools and pixelGroups after each simulation                 |
| NPP               | Data table | Net primary production per pixel group                          |
| emissionsProducts | matrix     | Total emissions and products for study area per simulation year |

## Links to other modules

- [CBM_defaults](https://github.com/PredictiveEcology/CBM_defaults)
- [CBM_dataPrep_SK](https://github.com/PredictiveEcology/CBM_dataPrep_SK.git)
- [CBM_vol2biomass](https://github.com/PredictiveEcology/CBM_vol2biomass)

